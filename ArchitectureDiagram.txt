Production-Grade MLOps Pipeline on AWS EKS
ğŸ—ï¸ High-Level Architecture
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AWS Cloud                             â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    EKS Cluster                          â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚   Airflow   â”‚  â”‚   MLflow    â”‚  â”‚  Prometheus â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ Scheduler   â”‚  â”‚   Server    â”‚  â”‚  & Grafana  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ & Workers   â”‚  â”‚             â”‚  â”‚             â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â”‚                                                         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚   FastAPI   â”‚  â”‚   KServe    â”‚  â”‚   Ingress   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚ Model API   â”‚  â”‚   Serving   â”‚  â”‚ Controller  â”‚    â”‚    â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚             â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚     S3      â”‚  â”‚     RDS     â”‚  â”‚     ECR     â”‚            â”‚
â”‚  â”‚  (Data &    â”‚  â”‚(PostgreSQL) â”‚  â”‚ (Container  â”‚            â”‚
â”‚  â”‚ Artifacts)  â”‚  â”‚             â”‚  â”‚  Registry)  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ CloudWatch  â”‚  â”‚     VPC     â”‚  â”‚     IAM     â”‚            â”‚
â”‚  â”‚  (Logging)  â”‚  â”‚ (Networking)â”‚  â”‚   (Auth)    â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      External Systems                           â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   GitHub    â”‚  â”‚   DVC       â”‚  â”‚   CI/CD     â”‚            â”‚
â”‚  â”‚  (Code)     â”‚  â”‚(Data Ver.)  â”‚  â”‚ (Actions)   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜



# MLOps Platform: High-Level Architecture Overview

## 1. High-Level Architecture Diagram

# [Diagram Placeholder]
# (To be rendered in draw.io, Lucidchart, or Mermaid for visuals)
# 
# Components:
# - GitHub/GitLab â†’ CI/CD (GitHub Actions or Jenkins)
# - DVC â†” S3
# - MLflow Tracking â†’ RDS (PostgreSQL) + S3
# - Training Jobs on EKS (Dockerized)
# - Airflow DAGs (running on EKS)
# - MLflow Registry
# - FastAPI/KServe (EKS)
# - Prometheus + Grafana (EKS)
# - Logs â†’ AWS CloudWatch
# - Ingress via NGINX/ALB + TLS + DNS (e.g., mlflow.myorg.com)

## 2. Kubernetes YAMLs (Simplified)

### MLflow Deployment
# (Use Helm chart or Kustomize preferred)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mlflow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mlflow
  template:
    metadata:
      labels:
        app: mlflow
    spec:
      containers:
        - name: mlflow
          image: mlflow/mlflow:latest
          args: ["mlflow", "server", "--backend-store-uri", "postgresql://<rds-uri>", "--default-artifact-root", "s3://mlflow-artifacts"]
          env:
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: aws-creds
                  key: access_key
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: aws-creds
                  key: secret_key
          ports:
            - containerPort: 5000

---
### Airflow Helm Values (via Astronomer Chart)
webserver:
  service:
    type: ClusterIP
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
    hosts:
      - airflow.myorg.com
    tls:
      - secretName: airflow-tls
        hosts:
          - airflow.myorg.com

dags:
  persistence:
    enabled: true
    existingClaim: airflow-dags-pvc

executor: KubernetesExecutor
logs:
  persistence:
    enabled: false

---
### Prometheus and Grafana via Helm
# helm install prometheus prometheus-community/kube-prometheus-stack
# Configure via `values.yaml`
prometheus:
  prometheusSpec:
    serviceMonitorSelectorNilUsesHelmValues: false

grafana:
  adminPassword: "<secure-password>"
  ingress:
    enabled: true
    annotations:
      kubernetes.io/ingress.class: nginx
    hosts:
      - grafana.myorg.com
    tls:
      - secretName: grafana-tls
        hosts:
          - grafana.myorg.com

## 3. Docker Setup

### Dockerfile for Training
FROM python:3.10
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
CMD ["python", "train.py"]

### Dockerfile for FastAPI Serving
FROM tiangolo/uvicorn-gunicorn-fastapi:python3.10
COPY ./app /app

## 4. CI/CD Pipelines (GitHub Actions)

### .github/workflows/mlops-pipeline.yml
```yaml
name: MLOps Pipeline
on:
  push:
    branches:
      - main
jobs:
  build-and-train:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Train model
        run: python train.py

      - name: Log to MLflow
        run: python log_to_mlflow.py

      - name: Build & Push Docker Image
        run: |
          docker build -t <ECR_URI>:latest .
          aws ecr get-login-password | docker login --username AWS --password-stdin <ECR_URI>
          docker push <ECR_URI>:latest

      - name: Deploy to Kubernetes
        run: kubectl apply -f k8s/deployment.yaml
```

## 5. Monitoring Config

### Prometheus scrape config (example)
```yaml
scrape_configs:
  - job_name: 'airflow'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_label_app]
        action: keep
        regex: airflow
```

### Grafana Dashboard
- Use Airflow, MLflow, KServe exporters
- Dashboard panels: pipeline duration, success rate, training time, drift alerts

## 6. Security & Access Management

- **IRSA**: IAM Role for Service Account for MLflow, Airflow to access S3, RDS
- **TLS**: Cert-Manager for automatic HTTPS certs
- **RBAC**: RoleBindings for Airflow and MLflow UIs

## 7. Infrastructure as Code (Terraform Sample)

### EKS & VPC
- `terraform-aws-eks` module
- `terraform-aws-vpc` module

### Sample block
```hcl
module "eks" {
  source          = "terraform-aws-modules/eks/aws"
  cluster_name    = "mlops-cluster"
  cluster_version = "1.29"
  vpc_id          = module.vpc.vpc_id
  subnet_ids      = module.vpc.private_subnets
  node_groups = {
    general = {
      desired_capacity = 2
      instance_types   = ["t3.medium"]
    }
    spot = {
      desired_capacity = 3
      instance_types   = ["t3.medium", "t3.large"]
      spot             = true
    }
  }
}
```

## 8. External Access URLs

- `https://mlflow.myorg.com` â†’ MLflow UI
- `https://airflow.myorg.com` â†’ Airflow UI
- `https://grafana.myorg.com` â†’ Dashboards

---

## ğŸ” Optimization Recommendations
- Use EKS Managed Node Groups with mixed On-Demand and Spot
- Enable Cluster Autoscaler
- Configure Resource Requests/Limits
- Use S3 Lifecycle Rules for artifacts
- Use NVIDIA GPU node group with tolerations for model training

## ğŸ“ Repo Structure
```bash
.
â”œâ”€â”€ .github/workflows/
â”‚   â””â”€â”€ mlops-pipeline.yml
â”œâ”€â”€ k8s/
â”‚   â”œâ”€â”€ mlflow-deployment.yaml
â”‚   â”œâ”€â”€ airflow-values.yaml
â”‚   â”œâ”€â”€ ingress.yaml
â”œâ”€â”€ terraform/
â”‚   â”œâ”€â”€ eks.tf
â”‚   â”œâ”€â”€ vpc.tf
â”‚   â”œâ”€â”€ rds.tf
â”œâ”€â”€ docker/
â”‚   â”œâ”€â”€ Dockerfile.train
â”‚   â””â”€â”€ Dockerfile.api
â”œâ”€â”€ training/
â”‚   â”œâ”€â”€ train.py
â”‚   â””â”€â”€ log_to_mlflow.py
â””â”€â”€ serving/
    â””â”€â”€ app/
        â”œâ”€â”€ main.py
        â””â”€â”€ model_loader.py
```

